<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚽ Penalty Shootout</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iOCIgY3k9IjgiIHI9IjciIGZpbGw9IndoaXRlIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjEiLz4KPHBhdGggZD0iTSA4IDEgQSA3IDcgMCAwIDEgOCAxNSIgc3Ryb2tlPSJibGFjayIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIi8+CjxwYXRoIGQ9Ik0gMSA4IEwgMTUgOCIgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxIi8+Cjwvc3ZnPgo=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e1a;
            --bg-field: #1a4d2e;
            --neon-green: #00ff41;
            --neon-blue: #00d4ff;
            --neon-yellow: #ffed4e;
            --neon-red: #ff073a;
            --white: #ffffff;
            --shadow-green: 0 0 20px var(--neon-green);
            --shadow-blue: 0 0 20px var(--neon-blue);
            --shadow-yellow: 0 0 20px var(--neon-yellow);
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--bg-dark);
            color: var(--white);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(90deg, #001f3f, #003d5c);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--neon-blue);
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
        }

        .title {
            font-size: 24px;
            color: var(--neon-blue);
            text-shadow: var(--shadow-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            display: flex;
            gap: 30px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .stat-label {
            color: #888;
            font-size: 11px;
        }

        .stat-value {
            color: var(--neon-green);
            font-weight: bold;
            font-size: 18px;
        }

        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        canvas {
            border: 3px solid var(--neon-blue);
            border-radius: 10px;
            box-shadow: var(--shadow-blue);
            cursor: crosshair;
            max-width: 100%;
            max-height: calc(100vh - 200px);
        }

        .power-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 10px;
            border: 2px solid var(--neon-yellow);
            box-shadow: var(--shadow-yellow);
            display: none;
        }

        .power-container.active {
            display: block;
        }

        .power-label {
            text-align: center;
            color: var(--neon-yellow);
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .power-bar {
            width: 300px;
            height: 20px;
            background: #222;
            border: 2px solid var(--neon-yellow);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .power-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-yellow), var(--neon-red));
            transition: width 0.05s linear;
        }

        .instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 40px;
            border-radius: 15px;
            border: 3px solid var(--neon-green);
            box-shadow: var(--shadow-green);
            text-align: center;
            max-width: 500px;
            z-index: 100;
        }

        .instructions.hidden {
            display: none;
        }

        .instructions h2 {
            color: var(--neon-green);
            margin-bottom: 20px;
            font-size: 28px;
            text-shadow: var(--shadow-green);
        }

        .instructions p {
            margin: 10px 0;
            line-height: 1.6;
            font-size: 14px;
        }

        .difficulty-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            border: 2px solid;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: bold;
        }

        .btn-easy {
            background: rgba(0, 255, 65, 0.2);
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .btn-easy:hover {
            background: rgba(0, 255, 65, 0.4);
            box-shadow: var(--shadow-green);
        }

        .btn-medium {
            background: rgba(255, 237, 78, 0.2);
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
        }

        .btn-medium:hover {
            background: rgba(255, 237, 78, 0.4);
            box-shadow: var(--shadow-yellow);
        }

        .btn-hard {
            background: rgba(255, 7, 58, 0.2);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .btn-hard:hover {
            background: rgba(255, 7, 58, 0.4);
            box-shadow: 0 0 20px var(--neon-red);
        }

        .back-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 8px 15px;
            background: rgba(0, 212, 255, 0.2);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(0, 212, 255, 0.4);
            box-shadow: var(--shadow-blue);
        }

        .message {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            font-weight: bold;
            padding: 20px 40px;
            border-radius: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 50;
        }

        .message.show {
            opacity: 1;
        }

        .message.goal {
            color: var(--neon-green);
            text-shadow: var(--shadow-green);
            background: rgba(0, 255, 65, 0.1);
            border: 2px solid var(--neon-green);
        }

        .message.miss {
            color: var(--neon-red);
            text-shadow: 0 0 20px var(--neon-red);
            background: rgba(255, 7, 58, 0.1);
            border: 2px solid var(--neon-red);
        }

        .message.save {
            color: var(--neon-yellow);
            text-shadow: var(--shadow-yellow);
            background: rgba(255, 237, 78, 0.1);
            border: 2px solid var(--neon-yellow);
        }

        @media (max-width: 768px) {
            .stats {
                gap: 15px;
            }

            .stat {
                font-size: 12px;
            }

            .power-bar {
                width: 200px;
            }

            .instructions {
                padding: 20px;
                max-width: 90%;
            }

            .difficulty-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">⚽ PENALTY SHOOTOUT</div>
        <div class="stats">
            <div class="stat">
                <div class="stat-label">SCORE</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">STREAK</div>
                <div class="stat-value" id="streak">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">HIGH SCORE</div>
                <div class="stat-value" id="highscore">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">ACCURACY</div>
                <div class="stat-value" id="accuracy">0%</div>
            </div>
        </div>
    </div>

    <div class="game-container">
        <a href="../index.html" class="back-btn">← BACK</a>

        <canvas id="gameCanvas"></canvas>

        <div class="power-container" id="powerContainer">
            <div class="power-label">SHOT POWER</div>
            <div class="power-bar">
                <div class="power-fill" id="powerFill"></div>
            </div>
        </div>

        <div class="message" id="message"></div>
    </div>

    <div class="instructions" id="instructions">
        <h2>⚽ HOW TO PLAY</h2>
        <p>1. Click on the goal to aim your shot</p>
        <p>2. Click again to set the power</p>
        <p>3. Beat the goalkeeper and score!</p>
        <p>4. Build streaks for bonus points</p>
        <p style="margin-top: 20px; color: var(--neon-yellow);">Choose your difficulty:</p>
        <div class="difficulty-buttons">
            <button class="btn btn-easy" onclick="startGame('easy')">EASY</button>
            <button class="btn btn-medium" onclick="startGame('medium')">MEDIUM</button>
            <button class="btn btn-hard" onclick="startGame('hard')">HARD</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = 900;
        canvas.height = 700;

        let gameState = {
            difficulty: 'medium',
            score: 0,
            streak: 0,
            highscore: localStorage.getItem('penaltyHighscore') || 0,
            totalShots: 0,
            goals: 0,
            phase: 'aiming',
            targetX: null,
            targetY: null,
            power: 0,
            powerDirection: 1,
            ball: null,
            goalkeeper: null,
            particles: [],
            crowd: [],
            crowdCheer: 0,
            shotChecked: false
        };

        // Better AI settings
        const difficulties = {
            easy: { speed: 0.15, reactionTime: 0.5, prediction: 0.3, coverage: 0.6 },
            medium: { speed: 0.25, reactionTime: 0.3, prediction: 0.6, coverage: 0.75 },
            hard: { speed: 0.35, reactionTime: 0.15, prediction: 0.85, coverage: 0.9 }
        };

        let audioContext;
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.log('Web Audio API not supported');
        }

        function playSound(frequency, duration, type = 'sine') {
            if (!audioContext) return;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = type;
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function startGame(difficulty) {
            gameState.difficulty = difficulty;
            document.getElementById('instructions').classList.add('hidden');
            initCrowd();
            updateStats();
            resetShot();
            gameLoop();
        }

        function initCrowd() {
            gameState.crowd = [];
            for (let i = 0; i < 100; i++) {
                gameState.crowd.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * 180 + 20,
                    size: Math.random() * 3 + 2,
                    color: Math.random() > 0.5 ? '#ff6b6b' : '#4dabf7',
                    phase: Math.random() * Math.PI * 2
                });
            }
        }

        function resetShot() {
            gameState.phase = 'aiming';
            gameState.targetX = null;
            gameState.targetY = null;
            gameState.power = 0;
            gameState.shotChecked = false;
            gameState.ball = {
                x: canvas.width / 2,
                y: canvas.height - 120,
                vx: 0,
                vy: 0,
                z: 0,
                vz: 0,
                radius: 18,
                rotation: 0
            };
            gameState.goalkeeper = {
                x: canvas.width / 2,
                y: 280,
                targetX: canvas.width / 2,
                diving: false,
                diveDirection: 0,
                diveProgress: 0,
                width: 100,
                height: 140,
                armAngle: 0
            };
            document.getElementById('powerContainer').classList.remove('active');
        }

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            if (gameState.phase === 'aiming') {
                if (y < 400 && x > 180 && x < 720) {
                    gameState.targetX = x;
                    gameState.targetY = y;
                    gameState.phase = 'power';
                    document.getElementById('powerContainer').classList.add('active');
                    playSound(800, 0.1);
                }
            } else if (gameState.phase === 'power') {
                shootBall();
            }
        });

        function updatePowerBar() {
            if (gameState.phase === 'power') {
                gameState.power += 0.025 * gameState.powerDirection;
                if (gameState.power >= 1 || gameState.power <= 0) {
                    gameState.powerDirection *= -1;
                }
                document.getElementById('powerFill').style.width = (gameState.power * 100) + '%';
            }
        }

        function shootBall() {
            gameState.phase = 'shooting';
            document.getElementById('powerContainer').classList.remove('active');
            gameState.totalShots++;

            const dx = gameState.targetX - gameState.ball.x;
            const dy = gameState.targetY - gameState.ball.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            const speed = 12 + gameState.power * 18;
            gameState.ball.vx = (dx / distance) * speed;
            gameState.ball.vy = (dy / distance) * speed;
            gameState.ball.vz = 12 + gameState.power * 8;

            // IMPROVED AI - Predicts shot direction better
            const difficulty = difficulties[gameState.difficulty];
            setTimeout(() => {
                const gk = gameState.goalkeeper;
                const predictionAccuracy = difficulty.prediction;

                // AI predicts target with some accuracy
                const predictedX = gameState.targetX * predictionAccuracy +
                                 (canvas.width / 2) * (1 - predictionAccuracy);

                // Add some randomness
                const randomness = (Math.random() - 0.5) * 100 * (1 - difficulty.coverage);
                gk.targetX = predictedX + randomness;

                // Clamp to goal area
                gk.targetX = Math.max(220, Math.min(680, gk.targetX));

                // Start diving animation
                gk.diving = true;
                gk.diveDirection = gk.targetX > gk.x ? 1 : -1;

                playSound(400, 0.2);
            }, difficulty.reactionTime * 1000);

            playSound(600, 0.3, 'square');
        }

        function update() {
            updatePowerBar();

            if (gameState.phase === 'shooting') {
                // Update ball
                gameState.ball.x += gameState.ball.vx;
                gameState.ball.y += gameState.ball.vy;
                gameState.ball.z += gameState.ball.vz;
                gameState.ball.vz -= 0.6;
                gameState.ball.rotation += 0.2;

                // Update goalkeeper with better movement
                const gk = gameState.goalkeeper;
                const gkDiff = gk.targetX - gk.x;
                const moveSpeed = difficulties[gameState.difficulty].speed;
                gk.x += gkDiff * moveSpeed;

                // Diving animation
                if (gk.diving && gk.diveProgress < 1) {
                    gk.diveProgress += 0.05;
                    gk.armAngle = gk.diveDirection * Math.sin(gk.diveProgress * Math.PI) * Math.PI / 2;
                }

                // Check goal ONLY ONCE when ball crosses line
                if (!gameState.shotChecked && gameState.ball.y <= 300 && gameState.ball.z > 0) {
                    gameState.shotChecked = true;
                    checkGoal();
                }

                // Ball went out or hit ground
                if ((gameState.ball.y < -50 || gameState.ball.x < -50 ||
                     gameState.ball.x > canvas.width + 50 || gameState.ball.z < -20) &&
                     gameState.shotChecked) {
                    setTimeout(resetShot, 1500);
                }
            }

            // Update crowd
            gameState.crowdCheer = Math.max(0, gameState.crowdCheer - 0.02);
            gameState.crowd.forEach(person => {
                person.phase += 0.05 + gameState.crowdCheer * 0.2;
            });

            // Update particles
            gameState.particles = gameState.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2;
                p.life -= 0.015;
                return p.life > 0;
            });
        }

        function checkGoal() {
            const ball = gameState.ball;
            const gk = gameState.goalkeeper;

            // Goal bounds
            const inGoalX = ball.x > 220 && ball.x < 680;
            const inGoalY = ball.y > 80 && ball.y < 400;

            if (!inGoalX || !inGoalY) {
                showMessage('WIDE!', 'miss');
                gameState.streak = 0;
                playSound(200, 0.5, 'sawtooth');
                updateStats();
                return;
            }

            // Enhanced goalkeeper collision with diving
            const gkReach = gk.diving ? gk.width * 1.8 : gk.width;
            const gkHeight = gk.diving ? gk.height * 0.6 : gk.height;
            const gkLeft = gk.x - gkReach / 2;
            const gkRight = gk.x + gkReach / 2;
            const gkTop = gk.y - gkHeight / 2;
            const gkBottom = gk.y + gkHeight / 2;

            const ballHitsGK = ball.x > gkLeft && ball.x < gkRight &&
                             ball.y > gkTop && ball.y < gkBottom;

            if (ballHitsGK) {
                showMessage('SAVED!', 'save');
                gameState.streak = 0;
                playSound(300, 0.3, 'square');
                updateStats();
                gameState.crowdCheer = 0.5;
            } else {
                // GOAL!
                gameState.goals++;
                gameState.streak++;
                const points = 10 + (gameState.streak - 1) * 5;
                gameState.score += points;

                if (gameState.score > gameState.highscore) {
                    gameState.highscore = gameState.score;
                    localStorage.setItem('penaltyHighscore', gameState.highscore);
                }

                showMessage(`GOAL! +${points}`, 'goal');
                createParticles(ball.x, ball.y, '#00ff41');
                playSound(800, 0.2);
                setTimeout(() => playSound(1000, 0.2), 100);
                setTimeout(() => playSound(1200, 0.3), 200);
                updateStats();
                gameState.crowdCheer = 1.0;
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message show ${type}`;
            setTimeout(() => {
                msg.classList.remove('show');
            }, 2000);
        }

        function createParticles(x, y, color) {
            for (let i = 0; i < 50; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 6 + 2;
                gameState.particles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed - 3,
                    color: color,
                    life: 1
                });
            }
        }

        function updateStats() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('streak').textContent = gameState.streak;
            document.getElementById('highscore').textContent = gameState.highscore;
            const accuracy = gameState.totalShots > 0
                ? Math.round((gameState.goals / gameState.totalShots) * 100)
                : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        function draw() {
            // Sky gradient
            const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            skyGradient.addColorStop(0, '#1a2a4a');
            skyGradient.addColorStop(1, '#0a0e1a');
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw crowd (stadium)
            drawCrowd();

            // Draw field with perspective
            drawField();

            // Draw goal
            drawGoal();

            // Draw goalkeeper
            drawGoalkeeper();

            // Draw target
            if (gameState.phase === 'aiming' && gameState.targetX) {
                drawTarget(gameState.targetX, gameState.targetY);
            }

            // Draw ball
            drawBall();

            // Draw particles
            drawParticles();

            // Draw instruction
            if (gameState.phase === 'aiming') {
                ctx.fillStyle = '#00d4ff';
                ctx.font = 'bold 18px Courier New';
                ctx.textAlign = 'center';
                ctx.shadowColor = '#00d4ff';
                ctx.shadowBlur = 10;
                ctx.fillText('Click on the goal to aim your shot!', canvas.width / 2, canvas.height - 40);
                ctx.shadowBlur = 0;
            }
        }

        function drawCrowd() {
            // Stadium stands
            ctx.fillStyle = '#2a2a3a';
            ctx.fillRect(0, 0, canvas.width, 200);

            ctx.fillStyle = '#1a1a2a';
            ctx.fillRect(0, 0, 200, 200);
            ctx.fillRect(canvas.width - 200, 0, 200, 200);

            // Crowd
            gameState.crowd.forEach(person => {
                const bounce = Math.sin(person.phase) * 3 * gameState.crowdCheer;
                ctx.fillStyle = person.color;
                ctx.beginPath();
                ctx.arc(person.x, person.y + bounce, person.size, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawField() {
            // Field gradient
            const fieldGradient = ctx.createLinearGradient(0, 200, 0, canvas.height);
            fieldGradient.addColorStop(0, '#2a5a3a');
            fieldGradient.addColorStop(1, '#1a4d2e');
            ctx.fillStyle = fieldGradient;
            ctx.fillRect(0, 200, canvas.width, canvas.height - 200);

            // Field lines with perspective
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 3;

            // Penalty box
            ctx.beginPath();
            ctx.moveTo(250, 320);
            ctx.lineTo(250, canvas.height);
            ctx.moveTo(650, 320);
            ctx.lineTo(650, canvas.height);
            ctx.moveTo(250, 320);
            ctx.lineTo(650, 320);
            ctx.stroke();

            // Goal box
            ctx.strokeRect(320, 240, 260, 80);

            // Penalty spot
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height - 120, 6, 0, Math.PI * 2);
            ctx.fill();

            // Center circle (perspective)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.beginPath();
            ctx.ellipse(canvas.width / 2, canvas.height + 50, 100, 30, 0, 0, Math.PI * 2);
            ctx.stroke();
        }

        function drawGoal() {
            // 3D Goal structure
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 6;

            // Back frame
            ctx.strokeRect(220, 80, 460, 320);

            // Side posts (3D effect)
            ctx.strokeStyle = '#cccccc';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(220, 80);
            ctx.lineTo(180, 120);
            ctx.moveTo(680, 80);
            ctx.lineTo(720, 120);
            ctx.moveTo(220, 400);
            ctx.lineTo(180, 420);
            ctx.moveTo(680, 400);
            ctx.lineTo(720, 420);
            ctx.stroke();

            // Net
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 12; i++) {
                ctx.beginPath();
                ctx.moveTo(220 + i * 38, 80);
                ctx.lineTo(220 + i * 38, 400);
                ctx.stroke();
            }
            for (let i = 0; i < 9; i++) {
                ctx.beginPath();
                ctx.moveTo(220, 80 + i * 40);
                ctx.lineTo(680, 80 + i * 40);
                ctx.stroke();
            }
        }

        function drawGoalkeeper() {
            const gk = gameState.goalkeeper;

            // Shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.beginPath();
            ctx.ellipse(gk.x, gk.y + 80, 50, 18, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.save();
            ctx.translate(gk.x, gk.y);

            // Diving lean
            if (gk.diving) {
                ctx.rotate(gk.diveDirection * gk.diveProgress * 0.3);
            }

            // Legs
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(-15, 30, 12, 50);
            ctx.fillRect(3, 30, 12, 50);

            // Body
            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(-30, -20, 60, 50);

            // Arms (animated)
            ctx.strokeStyle = '#e74c3c';
            ctx.lineWidth = 18;
            ctx.lineCap = 'round';

            const leftArmAngle = gk.armAngle - Math.PI / 6;
            const rightArmAngle = -gk.armAngle + Math.PI / 6;

            ctx.beginPath();
            ctx.moveTo(-25, -10);
            ctx.lineTo(-25 + Math.cos(leftArmAngle) * 45, -10 + Math.sin(leftArmAngle) * 45);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(25, -10);
            ctx.lineTo(25 + Math.cos(rightArmAngle) * 45, -10 + Math.sin(rightArmAngle) * 45);
            ctx.stroke();

            // Gloves
            ctx.fillStyle = '#00d4ff';
            ctx.beginPath();
            ctx.arc(-25 + Math.cos(leftArmAngle) * 45, -10 + Math.sin(leftArmAngle) * 45, 14, 0, Math.PI * 2);
            ctx.arc(25 + Math.cos(rightArmAngle) * 45, -10 + Math.sin(rightArmAngle) * 45, 14, 0, Math.PI * 2);
            ctx.fill();

            // Head
            ctx.fillStyle = '#ffcc99';
            ctx.beginPath();
            ctx.arc(0, -40, 22, 0, Math.PI * 2);
            ctx.fill();

            // Face details
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-8, -42, 3, 0, Math.PI * 2);
            ctx.arc(8, -42, 3, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        function drawBall() {
            const ball = gameState.ball;
            const scale = Math.max(0.1, 1 + ball.z * 0.008); // Prevent negative scale
            const radius = Math.max(5, ball.radius * scale); // Minimum radius of 5

            // Ball shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
            ctx.beginPath();
            ctx.ellipse(ball.x, canvas.height - 120, Math.abs(radius * 1.2), Math.abs(radius * 0.4), 0, 0, Math.PI * 2);
            ctx.fill();

            // Ball
            const gradient = ctx.createRadialGradient(
                ball.x - radius * 0.3,
                ball.y - ball.z - radius * 0.3,
                1, // Minimum inner radius
                ball.x,
                ball.y - ball.z,
                Math.max(2, radius) // Ensure outer radius > inner radius
            );
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(0.7, '#f0f0f0');
            gradient.addColorStop(1, '#cccccc');

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y - ball.z, radius, 0, Math.PI * 2);
            ctx.fill();

            // Ball pattern (pentagons)
            ctx.save();
            ctx.translate(ball.x, ball.y - ball.z);
            ctx.rotate(ball.rotation || 0); // Prevent NaN rotation
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;

            for (let i = 0; i < 5; i++) {
                const angle = (i * Math.PI * 2) / 5;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(Math.cos(angle) * radius * 0.6, Math.sin(angle) * radius * 0.6);
                ctx.stroke();
            }

            ctx.restore();
        }

        function drawTarget(x, y) {
            ctx.strokeStyle = '#00ff41';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);

            ctx.beginPath();
            ctx.arc(x, y, 35, 0, Math.PI * 2);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(x - 50, y);
            ctx.lineTo(x + 50, y);
            ctx.moveTo(x, y - 50);
            ctx.lineTo(x, y + 50);
            ctx.stroke();

            ctx.setLineDash([]);
        }

        function drawParticles() {
            gameState.particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        document.getElementById('highscore').textContent = gameState.highscore;
    </script>
</body>
</html>
